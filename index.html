<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Todo App</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <header></header>

    <main class="container-custom py-4" style="margin-top: 40px; margin-bottom: 40px">
        <div class="animate-fade-in">
            <h1 class="text-center" style="margin-bottom: 1rem;" id="greet-text">Dashboard</h1>

            <!-- Stats Row -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div class="glass-panel" style="padding: 20px; text-align: center;">
                    <h3 id="total-count" style="font-size: 3rem; color: var(--primary-color);">0</h3>
                    <p>My Total Todos</p>
                </div>
                <div class="glass-panel" style="padding: 20px; text-align: center;">
                    <h3 id="pending-count" style="font-size: 3rem; color: #f59e0b;">0</h3>
                    <p>My Pending</p>
                </div>
                <div class="glass-panel" style="padding: 20px; text-align: center;">
                    <h3 id="completed-count" style="font-size: 3rem; color: #10b981;">0</h3>
                    <p>My Completed</p>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>All Todos (Most Recent)</h2>
                <!-- <a href="create.html" class="btn-primary">New Todo</a> -->
            </div>

            <div id="recent-todos-list"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                <!-- Recent items will be injected here -->
            </div>
        </div>
    </main>

    <script type="module">
        import { renderNavbar } from './js/components/navbar.js';
        import { authService } from './js/services/auth.service.js';
        import { todoService } from './js/services/todo.service.js';

        // Check Auth & Render Nav
        const user = authService.getCurrentUser();
        if (!user) {
            window.location.href = 'login.html';
        } else {
            renderNavbar('home');
            document.getElementById('greet-text').textContent = `Welcome back, ${user.username}`;
            loadDashboard();
        }

        async function loadDashboard() {
            try {
                // Requirement 1: Stats for the current user
                const userTodos = await todoService.getTodos(user.id);
                document.getElementById('total-count').textContent = userTodos.length;
                document.getElementById('pending-count').textContent = userTodos.filter(t => !t.isCompleted).length;
                document.getElementById('completed-count').textContent = userTodos.filter(t => t.isCompleted).length;

                // Requirement 2: Display ALL todos on index, sorted most recent first
                const allTodos = await todoService.getAllTodos();

                // Sort by most recent (descending createdAt)
                const recent = allTodos.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                const list = document.getElementById('recent-todos-list');

                if (recent.length === 0) {
                    list.parentElement.innerHTML += '<p style="text-align:center; grid-column: 1/-1;">No todos found in the system.</p>';
                } else {
                    list.innerHTML = recent.map(todo => `
                        <div class="todo-card">
                            <h4 style="margin-bottom: 10px;">${escapeHtml(todo.title)}</h4>
                            <p style="margin-bottom: 15px; flex-grow: 1;">${todo.description ? escapeHtml(todo.description.substring(0, 100)) : ''}${todo.description && todo.description.length > 100 ? '...' : ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <small style="opacity: 0.7;">${todo.username || 'Anonymous'}</small>
                                <small style="opacity: 0.7;">${new Date(todo.createdAt).toLocaleDateString()}</small>

                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--glass-border); padding-top: 10px; margin-top: 10px;">
                                <span class="badge ${todo.isCompleted ? 'badge-complete' : 'badge-pending'}">
                                    ${todo.isCompleted ? 'Completed' : 'Pending'}
                                </span>
                                <small style="opacity: 0.7;">Todo #${todo.id || '?'}</small>
                            </div>
                        </div>
                    `).join('');
                }

            } catch (err) {
                console.error(err);
                if (err.message.includes('404')) {
                    alert("API Error: Please check endpoints.");
                }
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>

</body>

</html>